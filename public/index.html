<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Sign Detection</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 0;
            text-align: center;
        }
        h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        .main-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        .upload-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        .upload-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .upload-button:hover {
            background-color: #3d8b40;
        }
        .preview-section {
            margin-bottom: 2rem;
            text-align: center;
        }
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 5px;
            display: none;
        }
        .result-section {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 1.5rem;
            margin-top: 2rem;
            display: none;
        }
        .result-title {
            color: #4CAF50;
            margin-top: 0;
        }
        .alternative-predictions {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed #ccc;
        }
        .alt-prediction {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .alt-prediction:hover {
            background-color: #e9e9e9;
            cursor: pointer;
        }
        .prediction-selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .low-confidence {
            color: #FF9800;
            font-style: italic;
            margin-top: 0.5rem;
        }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4CAF50;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1rem 0;
            color: #666;
        }
        .camera-section {
            text-align: center;
            margin-bottom: 2rem;
            display: none;
        }
        #cameraView {
            width: 100%;
            max-width: 500px;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .option-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .camera-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .camera-quality-toggle {
            background-color: #9C27B0;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .camera-quality-toggle:hover {
            background-color: #7B1FA2;
        }
        .camera-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }
        .capture-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .capture-button:hover {
            background-color: #1976D2;
        }
        .detect-button {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 1rem;
            display: none;
        }
        .detect-button:hover {
            background-color: #F57C00;
        }
        #captureCanvas {
            display: none;
        }
    </style>
  </head>
  <body>
    <header>
        <div class="container">
            <h1>Traffic Sign Detection</h1>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="option-buttons">
                <button class="upload-button" id="showFileUploadButton">Upload Image</button>
                <button class="capture-button" id="showCameraButton">Use Camera</button>
            </div>

            <div class="upload-section" id="uploadSection">
                <h2>Upload a Traffic Sign Image</h2>
                <p>Our AI can detect 58 different types of traffic signs with high accuracy.</p>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <button class="upload-button" id="uploadButton">Choose Image</button>
                <button class="detect-button" id="uploadDetectButton">Detect Sign</button>
            </div>

            <div class="camera-section" id="cameraSection">
                <h2>Capture a Traffic Sign with Your Camera</h2>
                <p>Position the traffic sign in the center of the frame and click the capture button.</p>
                <div class="camera-controls">
                    <button class="camera-quality-toggle" id="cameraQualityToggle">High Quality: OFF</button>
                </div>
                <video id="cameraView" autoplay playsinline></video>
                <p class="camera-note">For best results, ensure good lighting and hold the camera steady.</p>
                <canvas id="captureCanvas"></canvas>
                <button class="capture-button" id="captureButton">Capture Image</button>
                <button class="detect-button" id="cameraDetectButton">Detect Sign</button>
            </div>

            <div class="preview-section">
                <img id="previewImage" class="preview-image" alt="Preview">
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing image...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="result-section" id="resultSection">
                <h3 class="result-title">Detection Result</h3>
                <p><strong>Sign Type:</strong> <span id="signType"></span></p>
                <p><strong>Confidence:</strong> <span id="confidence"></span></p>
                <p class="low-confidence" id="lowConfidenceWarning" style="display: none;">
                    Low confidence detection. Consider improving lighting or trying a different angle.
                </p>
                
                <div class="alternative-predictions" id="alternativePredictions">
                    <h4>Alternative Predictions</h4>
                    <div id="altPredictionsList"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; Made BY Khushi and Nikshay</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageInput');
            const uploadButton = document.getElementById('uploadButton');
            const previewImage = document.getElementById('previewImage');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('errorMessage');
            const resultSection = document.getElementById('resultSection');
            const signType = document.getElementById('signType');
            const confidence = document.getElementById('confidence');
            const lowConfidenceWarning = document.getElementById('lowConfidenceWarning');
            const alternativePredictions = document.getElementById('alternativePredictions');
            const altPredictionsList = document.getElementById('altPredictionsList');
            
            // Camera elements
            const showFileUploadButton = document.getElementById('showFileUploadButton');
            const showCameraButton = document.getElementById('showCameraButton');
            const uploadSection = document.getElementById('uploadSection');
            const cameraSection = document.getElementById('cameraSection');
            const cameraView = document.getElementById('cameraView');
            const captureButton = document.getElementById('captureButton');
            const captureCanvas = document.getElementById('captureCanvas');
            const cameraQualityToggle = document.getElementById('cameraQualityToggle');
            
            // Detect buttons
            const uploadDetectButton = document.getElementById('uploadDetectButton');
            const cameraDetectButton = document.getElementById('cameraDetectButton');
            
            let stream = null;
            let currentFile = null;
            let capturedImageData = null;
            let isHighQuality = false;
            
            // Camera quality settings
            const cameraConstraintsStandard = { 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'environment' 
                } 
            };
            
            const cameraConstraintsHigh = { 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'environment'
                } 
            };
            
            cameraQualityToggle.addEventListener('click', function() {
                isHighQuality = !isHighQuality;
                cameraQualityToggle.textContent = `High Quality: ${isHighQuality ? 'ON' : 'OFF'}`;
                
                // Restart camera with new settings
                if (stream) {
                    stopCamera();
                    startCamera();
                }
            });

            // Switch between upload and camera modes
            showFileUploadButton.addEventListener('click', function() {
                uploadSection.style.display = 'block';
                cameraSection.style.display = 'none';
                uploadDetectButton.style.display = 'none';
                cameraDetectButton.style.display = 'none';
                previewImage.style.display = 'none';
                resultSection.style.display = 'none';
                errorMessage.style.display = 'none';
                stopCamera();
            });

            showCameraButton.addEventListener('click', function() {
                uploadSection.style.display = 'none';
                cameraSection.style.display = 'block';
                uploadDetectButton.style.display = 'none';
                cameraDetectButton.style.display = 'none';
                previewImage.style.display = 'none';
                resultSection.style.display = 'none';
                errorMessage.style.display = 'none';
                startCamera();
            });

            // File upload functionality
            uploadButton.addEventListener('click', function() {
                imageInput.click();
            });

            imageInput.addEventListener('change', function() {
                if (imageInput.files && imageInput.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Store the current file for later use
                        currentFile = imageInput.files[0];
                        
                        // Display the preview image
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        
                        // Show the detect button
                        uploadDetectButton.style.display = 'inline-block';
                        
                        // Reset previous results
                        resultSection.style.display = 'none';
                        errorMessage.style.display = 'none';
                    };
                    
                    reader.readAsDataURL(imageInput.files[0]);
                }
            });
            
            // Detect button for uploaded images
            uploadDetectButton.addEventListener('click', function() {
                if (currentFile) {
                    detectSign(currentFile);
                }
            });

            // Camera functionality
            function startCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const constraints = isHighQuality ? cameraConstraintsHigh : cameraConstraintsStandard;
                    
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(function(mediaStream) {
                            stream = mediaStream;
                            cameraView.srcObject = mediaStream;
                            cameraView.play();
                            
                            // Log camera details
                            const videoTrack = mediaStream.getVideoTracks()[0];
                            console.log('Camera settings:', videoTrack.getSettings());
                        })
                        .catch(function(error) {
                            console.error("Could not access the camera: ", error);
                            
                            // If environment camera fails, try without facingMode constraint
                            const fallbackConstraints = { 
                                video: { 
                                    width: { ideal: isHighQuality ? 1280 : 640 },
                                    height: { ideal: isHighQuality ? 720 : 480 }
                                } 
                            };
                            
                            navigator.mediaDevices.getUserMedia(fallbackConstraints)
                                .then(function(mediaStream) {
                                    stream = mediaStream;
                                    cameraView.srcObject = mediaStream;
                                    cameraView.play();
                                })
                                .catch(function(finalError) {
                                    errorMessage.textContent = 'Error: Could not access the camera. ' + finalError.message;
                                    errorMessage.style.display = 'block';
                                });
                        });
                } else {
                    errorMessage.textContent = 'Error: Your browser does not support camera access.';
                    errorMessage.style.display = 'block';
                }
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                    stream = null;
                }
            }

            captureButton.addEventListener('click', function() {
                if (stream) {
                    try {
                        // Set canvas dimensions to match the video
                        captureCanvas.width = cameraView.videoWidth;
                        captureCanvas.height = cameraView.videoHeight;
                        
                        // Log canvas dimensions
                        console.log(`Canvas dimensions: ${captureCanvas.width}x${captureCanvas.height}`);
                        
                        // Draw the current video frame to the canvas
                        const context = captureCanvas.getContext('2d');
                        context.drawImage(cameraView, 0, 0, captureCanvas.width, captureCanvas.height);
                        
                        // For better quality, we'll use a higher quality setting for the JPEG
                        capturedImageData = captureCanvas.toDataURL('image/jpeg', 0.95);
                        
                        // Display the captured image
                        previewImage.src = capturedImageData;
                        previewImage.style.display = 'block';
                        
                        // Show the detect button
                        cameraDetectButton.style.display = 'inline-block';
                        
                        // Reset previous results
                        resultSection.style.display = 'none';
                        errorMessage.style.display = 'none';
                    } catch (error) {
                        console.error("Error capturing image:", error);
                        errorMessage.textContent = 'Error capturing image: ' + error.message;
                        errorMessage.style.display = 'block';
                    }
                }
            });
            
            // Detect button for camera images
            cameraDetectButton.addEventListener('click', function() {
                if (capturedImageData) {
                    detectSignFromBase64(capturedImageData);
                }
            });

            function displayPredictionResults(data) {
                loading.style.display = 'none';
                resultSection.style.display = 'block';
                
                // Primary prediction
                signType.textContent = data.class_name;
                confidence.textContent = (data.confidence * 100).toFixed(2) + '%';
                
                // Show warning for low confidence predictions
                if (data.confidence < 0.4) {
                    lowConfidenceWarning.style.display = 'block';
                } else {
                    lowConfidenceWarning.style.display = 'none';
                }
                
                // Display alternative predictions if available
                if (data.top_predictions && data.top_predictions.length > 1) {
                    altPredictionsList.innerHTML = '';
                    
                    data.top_predictions.forEach((prediction, index) => {
                        // Skip the first one as it's already displayed as the primary prediction
                        if (index === 0) return;
                        
                        const predDiv = document.createElement('div');
                        predDiv.className = 'alt-prediction';
                        predDiv.innerHTML = `
                            <strong>${prediction.class_name}</strong> 
                            (${(prediction.confidence * 100).toFixed(2)}%)
                        `;
                        
                        // Allow clicking on alternative prediction to select it
                        predDiv.addEventListener('click', function() {
                            // Update main prediction display
                            signType.textContent = prediction.class_name;
                            confidence.textContent = (prediction.confidence * 100).toFixed(2) + '%';
                            
                            // Visual indication
                            document.querySelectorAll('.alt-prediction').forEach(el => {
                                el.classList.remove('prediction-selected');
                            });
                            predDiv.classList.add('prediction-selected');
                            
                            // Update warning display
                            if (prediction.confidence < 0.4) {
                                lowConfidenceWarning.style.display = 'block';
                            } else {
                                lowConfidenceWarning.style.display = 'none';
                            }
                        });
                        
                        altPredictionsList.appendChild(predDiv);
                    });
                    
                    alternativePredictions.style.display = 'block';
                } else {
                    alternativePredictions.style.display = 'none';
                }
            }

            function detectSign(file) {
                loading.style.display = 'block';
                errorMessage.style.display = 'none';
                resultSection.style.display = 'none';

                const formData = new FormData();
                formData.append('image', file);

                fetch('/api/detect', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    displayPredictionResults(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    errorMessage.textContent = 'Error: ' + error.message;
                    errorMessage.style.display = 'block';
                });
            }

            function detectSignFromBase64(imageData) {
                loading.style.display = 'block';
                errorMessage.style.display = 'none';
                resultSection.style.display = 'none';

                fetch('/api/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    displayPredictionResults(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    errorMessage.textContent = 'Error: ' + error.message;
                    errorMessage.style.display = 'block';
                });
            }
        });
    </script>
  </body>
</html> 